YUI.add("moodle-atto_link-button",function(e,t){var n="atto_link",r={NEWWINDOW:"atto_link_openinnewwindow",URLINPUT:"atto_link_urlentry",JSURLINPUT:"atto_link_popupurl",WINDOWNAME:"atto_link_windowname",WINDOWX:"atto_link_windowx",WINDOWY:"atto_link_windowy",WINDOWPOSX:"atto_link_windowposx",WINDOWPOSY:"atto_link_windowposy"},i={URLINPUT:".atto_link_urlentry",JSURLINPUT:".atto_link_popupurl",WINDOWNAME:".atto_link_windowname",WINDOWX:".atto_link_windowx",WINDOWY:".atto_link_windowy",WINDOWPOSX:".atto_link_windowposx",WINDOWPOSY:".atto_link_windowposy"},s='<div id="atto_link_container"><form class="atto_form standardlink"><label for="{{elementid}}_atto_link_urlentry">{{get_string "enterurl" component}}</label><input class="fullwidth url {{CSS.URLINPUT}}" type="url" id="{{elementid}}_atto_link_urlentry" size="32"/><br/>{{#if showFilepicker}}<button class="openlinkbrowser" type="button">{{get_string "browserepositories" component}}</button>{{/if}}<button class="toggleoptions" type="button" style="float: right;">{{get_string "popupoptions" component}}</button><br><input type="checkbox" class="newwindow" id="{{elementid}}_{{CSS.NEWWINDOW}}"/><label class="sameline" for="{{elementid}}_{{CSS.NEWWINDOW}}">{{get_string "openinnewwindow" component}}</label><br/><div class="mdl-align"><br/><button type="submit" class="submit standardlink">{{get_string "createlink" component}}</button></div></form><form class="atto_form jslink hidden"><label for="{{elementid}}_atto_link_popupurl">{{get_string "popupurl" component}}</label><input class="fullwidth popupurl {{CSS.JSURLINPUT}}" type="url"id="{{elementid}}_atto_link_popupurl" size="32"/><br/>{{#if showFilepicker}}<button class="openlinkbrowser" type="button">{{get_string "browserepositories" component}}</button>{{/if}}<button class="toggleoptions" type="button" style="float: right;">{{get_string "popupoptions" component}}</button><br><label for="{{elementid}}_atto_link_windowname">{{get_string "windowname" component}}</label><input class="fullwidth {{CSS.WINDOWNAME}}" type="text" id="{{elementid}}_atto_link_windowname" size="32"/><label for="{{elementid}}_atto_link_windowsize">{{get_string "windowsize" component}}</label><input id="{{elementid}}_atto_link_windowsize" value="1000" class="{{CSS.WINDOWX}}"type="number" size="8" min="1" max="2000"/> x <input value="1000" class="{{CSS.WINDOWY}}" type="number" size="8" min="1" max="2000"/> px<label for="{{elementid}}_atto_link_windowpos">{{get_string "windowpos" component}}</label><input id="{{elementid}}_atto_link_windowposx" value="" class="{{CSS.WINDOWPOSX}}"type="number" size="8" min="0" max="2000"/> / <input value="" class="{{CSS.WINDOWPOSY}}" type="number" size="8" min="0" max="2000"/><div class="mdl-align"><br/><button type="submit" class="submit jslink">{{get_string "createlink" component}}</button></div></form></div>';e.namespace("M.atto_link").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,initializer:function(){this.addButton({icon:"e/insert_edit_link",callback:this._displayDialogue,tags:"a",tagMatchRequiresAll:!1}),this.addButton({buttonName:"unlink",callback:this._unlink,icon:"e/remove_link",title:"unlink",tags:"a",tagMatchRequiresAll:!1})},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;var e=this.getDialogue({headerContent:M.util.get_string("createlink",n),focusAfterHide:!0,focusOnShowSelector:i.URLINPUT});e.set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),e.show()},_resolveAnchors:function(){var t=this.get("host").getSelectionParentNode(),n,r,s,o,u,a,f,l,c,h=[],p;if(!t)return;n=this._findSelectedAnchors(e.one(t)),n.length>0&&(r=n[0],this._currentSelection=this.get("host").getSelectionFromNode(r),s=r.getAttribute("href"),p=r.getAttribute("target"),o=r.getAttribute("onclick"),s!==""&&(this._content.one(".url").setAttribute("value",s),this._content.one(".popupurl").setAttribute("value",s)),p==="_blank"?this._content.one(".newwindow").setAttribute("checked","checked"):this._content.one(".newwindow").removeAttribute("checked"),o!==""&&(this._content.one("form.standardlink").addClass("hidden"),this._content.one("form.jslink").removeClass("hidden"),o=o.replace(/\'/g,""),h=o.split(","),u=h[1],a=parseInt(h[2].substring(h[2].indexOf("=")+1,h[2].length),10),f=parseInt(h[3].substring(h[3].indexOf("=")+1,h[3].length),10),l=parseInt(h[4].substring(h[4].indexOf("=")+1,h[4].length),10),c=parseInt(h[5].substring(h[5].indexOf("=")+1,h[5].length),10),this._content.one(i.WINDOWNAME).setAttribute("value",u),this._content.one(i.WINDOWY).setAttribute("value",f),this._content.one(i.WINDOWX).setAttribute("value",a),this._content.one(i.WINDOWPOSY).setAttribute("value",c),this._content.one(i.WINDOWPOSX).setAttribute("value",l)))},_filepickerCallback:function(e){this.getDialogue().set("focusAfterHide",null).hide(),e.url!==""&&(this._setLinkOnSelection(e.url),this.markUpdated())},_setLink:function(t){var n,r,i,s,o;t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),n=this._content.one(".url"),o=n.get("value");if(o!==""){o=o.trim();var u=new RegExp(/^[a-zA-Z]*\.*\/|^#|^[a-zA-Z]*:/);u.test(o)||(o="http://"+o),i=this._setLinkOnSelection(o);if(!i)return;s=this._findSelectedAnchors(e.one(i)),e.Array.each(s,function(e){r=this._content.one(".newwindow"),r.get("checked")?e.setAttribute("target","_blank"):e.removeAttribute("target")},this),this.markUpdated()}},_setJSLink:function(t){var n,r,i,s,o,u,a,f,l,c="";t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),n=this._content.one(".atto_link_popupurl").get("value"),s=this._content.one(".atto_link_windowname").get("value"),o=this._content.one(".atto_link_windowx").get("value"),u=this._content.one(".atto_link_windowy").get("value"),a=this._content.one(".atto_link_windowposx").get("value"),f=this._content.one(".atto_link_windowposy").get("value");if(n!==""){r=this._setLinkOnSelection(n);if(!r)return;o!==""&&u!==""&&
(c="width="+o+",height="+u+",left="+a+",top="+f),l="window.open('"+n+"','"+s+"','"+c+"');return false;",i=this._findSelectedAnchors(e.one(r)),e.Array.each(i,function(e){e.setAttribute("onClick",l)}),this.markUpdated()}},_setLinkOnSelection:function(t){var n=this.get("host"),r,i;return this.editor.focus(),n.setSelection(this._currentSelection),this._currentSelection[0].collapsed?(r=e.Node.create("<a>"+t+"</a>"),r.setAttribute("href",t),i=n.insertContentAtFocusPoint(r.get("outerHTML")),n.setSelection(n.getSelectionFromNode(i))):(document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,t),i=n.getSelectionParentNode()),i},_findSelectedAnchors:function(e){var t=e.get("tagName"),n,r;return t&&t.toLowerCase()==="a"?[e]:(r=[],e.all("a").each(function(e){!n&&this.get("host").selectionContainsNode(e)&&r.push(e)},this),r.length>0?r:(n=e.ancestor("a"),n?[n]:[]))},_getDialogueContent:function(){var t=this.get("host").canShowFilepicker("link"),i=e.Handlebars.compile(s);return this._content=e.Node.create(i({showFilepicker:t,component:n,CSS:r})),this._content.one(".submit.standardlink").on("click",this._setLink,this),this._content.one(".submit.jslink").on("click",this._setJSLink,this),this._content.all(".toggleoptions").each(function(){this.on("click",function(){e.all("form.standardlink, form.jslink").each(function(){this.toggleClass("hidden")})})}),t&&(this._content.one("form.standardlink .openlinkbrowser").on("click",function(e){e.preventDefault(),this.get("host").showFilepicker("link",this._filepickerCallback,this)},this),this._content.one("form.jslink .openlinkbrowser").on("click",function(e){e.preventDefault(),this.get("host").showFilepicker("link",this._filepickerCallback,this)},this)),this._content},_unlink:function(){var e=this.get("host"),t=e.getSelection();if(t&&t.length)if(t[0].startOffset===t[0].endOffset){var n=e.getSelectedNodes();n&&(n.each(function(t){var n=t.ancestor("a",!0);n&&(e.setSelection(e.getSelectionFromNode(n)),document.execCommand("unlink",!1,null))},this),this.markUpdated())}else document.execCommand("unlink",!1,null),this.markUpdated()}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
